name: singularity-deploy

on: 
  workflow_dispatch

jobs:
  release:
    permissions: write-all
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Define Repository Name and Release Version
        run: |
            release=$(cat VERSION)
            echo "release_tag=$release" >> $GITHUB_ENV
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.release_tag }}
          release_name: Release ${{ env.release_tag }}
          draft: false
          prerelease: false
      - uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.2.2
      - name: Build the singularity container
        run: |
            git clone https://github.com/panxiaoguang/Singularity_GISTIC.git
            cd Singularity_GISTIC
            apptainer build --fakeroot Gistic2.sif Gistic2.def
            echo "Successfully built container Gistic2.sif."                
            mv Gistic2.sif ../
            cd ..
      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          upload_url: ${{ steps.create_release.outputs.upload_url }} 
          tag_name: ${{ env.release_tag }}
        run: |
             sudo apt-get update && sudo apt-get install -y hub
             hub release edit $(find . -type f -name "*.sif" -printf "-a %p ") -m "" "$tag_name" 